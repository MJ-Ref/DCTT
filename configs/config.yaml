# DCTT Root Configuration
# Use Hydra's composition: python script.py model=qwen2_5_coder compute=local_m3

defaults:
  - model: qwen2_5_7b
  - pipeline: full
  - compute: local_m3
  - experiment: census
  - _self_

# Global settings
seed: 42
debug: false

# Output directory (Hydra will set this)
output_dir: ${hydra:runtime.output_dir}

# Reproducibility tracking
tracking:
  enabled: true
  log_git_hash: true
  log_env_hash: true
  log_config_snapshot: true

# Weights & Biases
wandb:
  enabled: true
  project: "dctt"
  entity: null  # Set via environment or override
  tags: []
  notes: ""

# Neighborhood settings
neighbors:
  k: 50  # Default neighborhood size
  k_variants: [25, 50, 100, 200]  # For consistency estimation
  metric: "ip"  # inner product (for normalized vectors, equivalent to cosine)
  exclude_self: true

# Stress test settings
stress_test:
  n_tokens: 50  # Number of high/low severity tokens to test
  n_prompts: 5  # Prompts per token
  max_new_tokens: 32  # Generation cap for stress-test responses
  scoring_mode: "logprob_choice"  # generation | logprob_choice
  min_logprob_margin: 0.0  # Required best-vs-second margin in logprob choice mode
  use_mock: false  # Use mock model for testing

# Repair validation settings
repair_validation:
  n_tokens: 10  # Number of tokens to repair
  n_diagnostic_samples: 5000  # Sample size for diagnostic

# Predictive validity settings
predictive_validity:
  n_bootstrap: 100  # Bootstrap samples for confidence intervals
  failure_threshold: 0.3  # Threshold for binarizing failure rate
  use_simulated_failures: false  # Synthetic labels are smoke-test only

# Repair settings
repair:
  learning_rate: 0.1
  lambda_anchor: 0.1
  lambda_nn_preserve: 0.1
  delta_max: 0.2

# Cluster repair settings
cluster_repair:
  n_top_tokens: 200  # Top severity tokens to consider
  n_diagnostic_samples: 5000  # Sample for finding high-severity tokens
  mutual_k: 20  # k for mutual k-NN graph
  min_cluster_size: 3  # Minimum tokens to form a cluster
  max_outer_iters: 3
  max_inner_steps: 50
  learning_rate: 0.05
  lambda_anchor: 0.5
  delta_max: 0.15

# Causal experiment settings
causal:
  n_treatment_clusters: 10  # Number of clusters for treatment group
  n_bootstrap: 1000  # Bootstrap samples for CIs
  confidence_level: 0.95  # CI confidence level
  use_simulated_outcomes: true  # Use simulated stress test outcomes

# Metric computation
metrics:
  eps: 1e-10  # Numerical stability
  variance_threshold: 0.95  # For dim95 computation
  m_min: 10  # Minimum effective dimension for condition number

# Hydra configuration
hydra:
  run:
    dir: outputs/runs/${now:%Y-%m-%d}/${now:%H-%M-%S}
  sweep:
    dir: outputs/sweeps/${now:%Y-%m-%d}/${now:%H-%M-%S}
    subdir: ${hydra.job.num}
  job:
    chdir: false
